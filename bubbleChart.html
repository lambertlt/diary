<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“¸ é«˜æ¸…ç‰ˆ + ç‚¹å‡»æ”¾å¤§é¢„è§ˆ</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      padding: 20px;
      background: #f8f9fa;
      color: #333;
    }
    h2 {
      color: #2c3e50;
    }
    .info {
      color: #666;
      font-size: 14px;
      margin-bottom: 15px;
    }
    #fileInput {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
    }

    .result-row {
      margin: 25px 0;
      padding: 18px;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      background: #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .meta-info {
      margin-bottom: 15px;
      padding: 12px;
      background: #f1f5f9;
      border-radius: 6px;
      font-size: 14px;
      line-height: 1.6;
    }

    .meta-info strong {
      display: inline-block;
      width: 140px;
      color: #1a73e8;
    }

    .image-section {
      margin: 15px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
      border: 1px dashed #ccc;
    }

    .section-title {
      font-weight: bold;
      color: #333;
      margin: 0 0 8px 0;
      font-size: 15px;
    }

    .thumb-img {
      max-height: 120px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      object-fit: contain;
      cursor: pointer;
    }

    .row-canvas {
      max-width: 100%;
      border: 1px solid #ddd;
      display: block;
      margin: 8px 0;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      cursor: pointer;
    }

    .copy-btn {
      padding: 6px 12px;
      font-size: 13px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 8px;
    }
    .copy-btn:hover {
      background: #0d62c9;
    }

    .status {
      display: inline-block;
      color: #d32f2f;
      font-size: 13px;
      margin-left: 10px;
      min-height: 18px;
    }
    .success {
      color: #388e3c;
    }

    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      animation: fadeIn 0.3s ease-in-out;
    }

    .modal-content {
      max-width: 90vw;
      max-height: 90vh;
      object-fit: contain;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      font-size: 28px;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10001;
      opacity: 0.8;
    }

    .modal-close:hover {
      opacity: 1;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>
<body>

  <h2>ğŸ“¸ é«˜æ¸…ç‰ˆ + ç‚¹å‡»æ”¾å¤§é¢„è§ˆ + åŒå¤åˆ¶</h2>
  <p class="info">æ”¯æŒé«˜æ¸…æ¸²æŸ“ã€ä¸€é”®å¤åˆ¶ã€ç‚¹å‡»å›¾ç‰‡æŸ¥çœ‹åŸå›¾</p>

  <input type="file" id="fileInput" accept=".xlsx, .xls" />
  <div id="results"></div>

  <!-- ä¾èµ–åº“ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    const fileInput = document.getElementById('fileInput');
    const resultsDiv = document.getElementById('results');

    fileInput.addEventListener('change', handleFile);

    // åˆ›å»ºæ¨¡æ€æ¡†ï¼ˆç”¨äºæ”¾å¤§é¢„è§ˆï¼‰
    function createModal(imgSrc) {
      const modal = document.createElement('div');
      modal.className = 'modal';

      const img = document.createElement('img');
      img.src = imgSrc;
      img.className = 'modal-content';
      img.alt = 'åŸå›¾é¢„è§ˆ';

      const closeBtn = document.createElement('button');
      closeBtn.className = 'modal-close';
      closeBtn.innerHTML = 'Ã—';
      closeBtn.onclick = () => document.body.removeChild(modal);

      modal.appendChild(img);
      modal.appendChild(closeBtn);

      // ç‚¹å‡»èƒŒæ™¯å…³é—­
      modal.onclick = (e) => {
        if (e.target === modal) {
          document.body.removeChild(modal);
        }
      };

      return modal;
    }

    async function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      resultsDiv.innerHTML = '<p>ğŸ”„ æ­£åœ¨å¤„ç†æ–‡ä»¶...</p>';

      try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        if (jsonData.length < 2) {
          resultsDiv.innerHTML = '<p>âŒ Excel ä¸­æ²¡æœ‰è¶³å¤Ÿçš„æ•°æ®è¡Œã€‚</p>';
          return;
        }

        const headers = jsonData[0];
        const rows = jsonData.slice(1);

        const bubbleIdx = headers.indexOf('bubble_img_url');
        const urlIndices = [];
        for (let i = 1; i <= 10; i++) {
          const idx = headers.indexOf(`url${i}`);
          if (idx !== -1) urlIndices.push(idx);
        }

        if (bubbleIdx === -1 && urlIndices.length === 0) {
          resultsDiv.innerHTML = '<p>âŒ æœªæ‰¾åˆ° bubble_img_url æˆ– url1~url10 åˆ—ã€‚</p>';
          return;
        }

        const metaFields = [
          'åºå·', 'spot_id', 'spot_name', 'bubble_img_url',
          'score', 'feature_tags', 'image_description'
        ];

        resultsDiv.innerHTML = '';

        for (const row of rows) {
          const rowObj = {};
          headers.forEach((h, i) => { rowObj[h] = row[i]; });

          const bubbleUrl = rowObj['bubble_img_url'];
          const hasBubble = bubbleUrl && typeof bubbleUrl === 'string' && /^https?:\/\//i.test(bubbleUrl);

          const urls = urlIndices
            .map(i => row[i])
            .filter(val => val && typeof val === 'string' && /^https?:\/\//i.test(val.trim()))
            .map(s => s.trim());

          const rowDiv = document.createElement('div');
          rowDiv.className = 'result-row';

          // === å…ƒä¿¡æ¯ ===
          const metaDiv = document.createElement('div');
          metaDiv.className = 'meta-info';
          let metaHTML = '';
          metaFields.forEach(field => {
            const value = rowObj[field];
            if (value && field !== 'bubble_img_url') {
              metaHTML += `<strong>${field}:</strong> ${value}<br>`;
            }
          });
          metaDiv.innerHTML = metaHTML;
          rowDiv.appendChild(metaDiv);

          // === æ°”æ³¡å›¾ï¼ˆæ”¯æŒç‚¹å‡»æ”¾å¤§ï¼‰===
          if (hasBubble) {
            const bubbleSection = document.createElement('div');
            bubbleSection.className = 'image-section';

            const title = document.createElement('div');
            title.className = 'section-title';
            title.textContent = 'æ°”æ³¡å›¾ï¼ˆç‚¹å‡»æ”¾å¤§ï¼‰';
            bubbleSection.appendChild(title);

            const img = document.createElement('img');
            img.className = 'thumb-img';
            img.alt = 'æ°”æ³¡å›¾';
            img.crossOrigin = 'anonymous';
            img.src = bubbleUrl;

            const status = document.createElement('span');
            status.className = 'status';

            const btn = document.createElement('button');
            btn.className = 'copy-btn';
            btn.textContent = 'ğŸ“‹ å¤åˆ¶åŸå›¾';

            // ğŸ”¥ ç‚¹å‡»å›¾ç‰‡æ”¾å¤§
            img.onclick = () => document.body.appendChild(createModal(bubbleUrl));

            bubbleSection.appendChild(img);
            bubbleSection.appendChild(btn);
            bubbleSection.appendChild(status);
            rowDiv.appendChild(bubbleSection);

            // ğŸ”¥ å¤åˆ¶åŸå›¾ï¼ˆé«˜æ¸…ï¼‰
            btn.addEventListener('click', async () => {
              if (!navigator.clipboard?.write) {
                status.textContent = 'âŒ ä¸æ”¯æŒ';
                return;
              }

              try {
                const blob = await urlToHighQualityPng(bubbleUrl);
                await navigator.clipboard.write([
                  new ClipboardItem({ 'image/png': blob })
                ]);
                status.textContent = 'âœ… å·²å¤åˆ¶ï¼';
                status.className = 'status success';
                setTimeout(() => {
                  status.textContent = '';
                  status.className = 'status';
                }, 2000);
              } catch (err) {
                console.error('å¤åˆ¶æ°”æ³¡å›¾å¤±è´¥:', err);
                status.textContent = 'âŒ å¤±è´¥';
              }
            });
          }

          // === æ‹¼æ¥å›¾ï¼ˆæ”¯æŒç‚¹å‡»æ”¾å¤§ï¼‰===
          if (urls.length > 0) {
            const images = await loadImages(urls);
            if (images.length > 0) {
              const pngBlob = await combineImagesHighRes(images, 5, 300); // 300px é«˜åº¦
              const imageUrl = URL.createObjectURL(pngBlob); // ç”¨äºé¢„è§ˆ

              const concatSection = document.createElement('div');
              concatSection.className = 'image-section';

              const title = document.createElement('div');
              title.className = 'section-title';
              title.textContent = 'æ‹¼æ¥å›¾ï¼ˆç‚¹å‡»æ”¾å¤§ï¼‰';
              concatSection.appendChild(title);

              const canvas = document.createElement('canvas');
              canvas.className = 'row-canvas';

              const status = document.createElement('span');
              status.className = 'status';

              const btn = document.createElement('button');
              btn.className = 'copy-btn';
              btn.textContent = 'ğŸ“‹ å¤åˆ¶é«˜æ¸…æ‹¼æ¥å›¾';

              // æ¸²æŸ“åˆ° canvas
              const bitmap = await createImageBitmap(pngBlob);
              canvas.width = bitmap.width;
              canvas.height = bitmap.height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(bitmap, 0, 0);
              bitmap.close();

              // ğŸ”¥ ç‚¹å‡»æ‹¼æ¥å›¾æ”¾å¤§
              canvas.onclick = () => document.body.appendChild(createModal(imageUrl));

              concatSection.appendChild(canvas);
              concatSection.appendChild(btn);
              concatSection.appendChild(status);
              rowDiv.appendChild(concatSection);

              // ğŸ”¥ å¤åˆ¶æ‹¼æ¥å›¾
              btn.addEventListener('click', async () => {
                if (!navigator.clipboard?.write) {
                  status.textContent = 'âŒ ä¸æ”¯æŒ';
                  return;
                }

                try {
                  await navigator.clipboard.write([
                    new ClipboardItem({ 'image/png': pngBlob })
                  ]);
                  status.textContent = 'âœ… å·²å¤åˆ¶ï¼';
                  status.className = 'status success';
                  setTimeout(() => {
                    status.textContent = '';
                    status.className = 'status';
                  }, 2000);
                } catch (err) {
                  console.error('å¤åˆ¶æ‹¼æ¥å›¾å¤±è´¥:', err);
                  status.textContent = 'âŒ å¤±è´¥';
                }
              });
            }
          }

          resultsDiv.appendChild(rowDiv);
        }

        if (resultsDiv.children.length === 0) {
          resultsDiv.innerHTML = '<p>âš ï¸ æœªåŠ è½½åˆ°ä»»ä½•æœ‰æ•ˆå›¾ç‰‡ã€‚</p>';
        }

      } catch (err) {
        resultsDiv.innerHTML = `<p style="color:red">âŒ å¤„ç†å¤±è´¥: ${err.message}</p>`;
        console.error(err);
      }
    }

    // åŠ è½½å›¾ç‰‡
    function loadImages(urls) {
      const promises = urls.map(url => {
        return new Promise(resolve => {
          const img = new Image();
          img.crossOrigin = 'anonymous';
          img.onload = () => resolve(img);
          img.onerror = () => resolve(null);
          img.src = url;
        });
      });
      return Promise.all(promises).then(list => list.filter(i => i));
    }

    // è½¬ä¸ºé«˜æ¸… PNGï¼ˆåŸå›¾åˆ†è¾¨ç‡ï¼‰
    async function urlToHighQualityPng(url) {
      const img = await new Promise((resolve, reject) => {
        const i = new Image();
        i.crossOrigin = 'anonymous';
        i.onload = () => resolve(i);
        i.onerror = reject;
        i.src = url;
      });

      const canvas = new OffscreenCanvas(img.width, img.height);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);
      return await canvas.convertToBlob({ type: 'image/png' });
    }

    // é«˜æ¸…æ‹¼æ¥ï¼ˆå¯è°ƒé«˜åº¦ï¼‰
    async function combineImagesHighRes(images, gap = 5, targetHeight = 300) {
      const imgData = images.map(img => {
        const ratio = targetHeight / img.height;
        return {
          img,
          width: Math.round(img.width * ratio),
          height: targetHeight
        };
      });

      const totalWidth = imgData.reduce((w, item) => w + item.width, 0) + gap * (imgData.length - 1);
      const offCanvas = new OffscreenCanvas(totalWidth, targetHeight);
      const ctx = offCanvas.getContext('2d');
      ctx.fillStyle = '#fff';
      ctx.fillRect(0, 0, totalWidth, targetHeight);

      let x = 0;
      for (const { img, width, height } of imgData) {
        ctx.drawImage(img, x, 0, width, height);
        x += width + gap;
      }

      return await offCanvas.convertToBlob({ type: 'image/png' });
    }
  </script>
</body>
</html>

